# We do not compile the code, we just take the ready-made artifact
install:
  - |
    echo "Current Tag: $JITPACK_TAG"
    
    # Remove the 'v' prefix if it exists (v1.1.7 -> 1.1.7)
    VERSION=${JITPACK_TAG#v}
    echo "Clean Version: $VERSION"
    
    # Form the file name
    JAR_NAME="ua-parser-${VERSION}.jar"
    
    # Form the download URL from your repository releases
    DOWNLOAD_URL="https://github.com/Octanium91/ua-parser/releases/download/${JITPACK_TAG}/${JAR_NAME}"
    echo "Target URL: $DOWNLOAD_URL"
    
    # --- SMART WAIT LOOP START ---
    # JitPack starts faster than GitHub Actions finishes the release.
    # We will try to download the file for 15 minutes (30 attempts * 30 seconds).
    MAX_ATTEMPTS=30
    SLEEP_SEC=30
    DOWNLOADED=false
    
    for i in $(seq 1 $MAX_ATTEMPTS); do
        echo "[Attempt $i/$MAX_ATTEMPTS] Trying to download JAR..."
    
        # Try to download. If fail, remove the empty file if created.
        if wget -O $JAR_NAME $DOWNLOAD_URL; then
            if [ -s "$JAR_NAME" ]; then
                echo "Success! File downloaded."
                DOWNLOADED=true
                break
            fi
        fi
    
        echo "File not found yet (GitHub Action is probably still running). Waiting ${SLEEP_SEC}s..."
        rm -f $JAR_NAME
        sleep $SLEEP_SEC
    done
    
    if [ "$DOWNLOADED" = false ]; then
        echo "Error: Timeout waiting for JAR file in GitHub Releases."
        exit 1
    fi
    # --- SMART WAIT LOOP END ---
    
    # Update version and groupId in pom.xml to match the current release and fork
    POM_FILE="clients/java/pom.xml"
    # 1. Update version (must match JITPACK_TAG for JitPack to find the artifact)
    sed -i "s|<version>[^<]*</version> <!-- Placeholder, managed by CI -->|<version>${JITPACK_TAG}</version> <!-- Placeholder, managed by CI -->|g" $POM_FILE
    # 2. Update groupId to support forks
    sed -i "s|<groupId>com.github.Octanium91</groupId>|<groupId>com.github.${JITPACK_USER}</groupId>|g" $POM_FILE

    echo "Updated pom.xml for JitPack:"
    cat $POM_FILE

    # Install the downloaded JAR into the local JitPack repository using the updated POM
    mvn install:install-file \
      -Dfile=$JAR_NAME \
      -DpomFile=$POM_FILE